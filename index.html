<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Circular Remote</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1DB954;
            --dark: #191414;
            --light: #FFFFFF;
        }

        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #000;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            overflow: hidden;
        }

        #remote-container {
            width: 95vmin;
            height: 95vmin;
            max-width: 500px;
            max-height: 500px;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(29, 185, 84, 0.3);
            border: 2px solid #333;
        }

        #bg-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            filter: blur(15px) brightness(0.4);
            z-index: 1;
            transition: background-image 0.5s ease;
        }

        #ui-layer {
            position: relative;
            z-index: 2;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 40px 0;
            box-sizing: border-box;
            color: var(--light);
        }

        .top-controls {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            backdrop-filter: blur(5px);
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .song-info {
            text-align: center;
            width: 70%;
        }

        #track-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #artist-name {
            font-size: 1rem;
            opacity: 0.8;
        }

        .main-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 50px;
        }

        .btn-control {
            background: none;
            border: none;
            color: var(--light);
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.8;
            transition: transform 0.1s;
        }

        .btn-control:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .btn-play {
            font-size: 2.5rem;
            background: var(--light);
            color: var(--dark);
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        #login-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 10;
            display: flex; /* Flex by default, JS will hide */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .login-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 20px;
        }

        .modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 5;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .modal.active {
            display: flex;
        }

        .list-container {
            width: 80%;
            height: 60%;
            overflow-y: auto;
            text-align: center;
        }

        .list-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
        }
        .list-item:hover { color: var(--primary); }
        .list-item.active-device { color: var(--primary); font-weight: bold;}

        .close-modal {
            margin-top: 15px;
            background: none;
            border: 1px solid white;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="remote-container">
        <div id="bg-image"></div>

        <div id="login-overlay">
            <h2>Connect to Spotify</h2>
            <p style="width: 70%;">Control your music from this circular display.</p>
            <button class="login-btn" onclick="startAuthFlow()">Login</button>
        </div>

        <div id="ui-layer">
            <div class="top-controls">
                <button class="btn-secondary" onclick="openPlaylists()"><i class="fas fa-list"></i> Playlists</button>
                <button class="btn-secondary" onclick="openDevices()"><i class="fas fa-desktop"></i> Devices</button>
            </div>

            <div class="song-info">
                <div id="track-name">Not Playing</div>
                <div id="artist-name">Connect a device</div>
            </div>

            <div class="main-controls">
                <button class="btn-control" onclick="previousTrack()"><i class="fas fa-step-backward"></i></button>
                <button class="btn-control" onclick="seek(-15000)"><i class="fas fa-undo"></i></button>
                <button class="btn-control btn-play" id="play-pause-btn" onclick="togglePlay()">
                    <i class="fas fa-play"></i>
                </button>
                <button class="btn-control" onclick="seek(15000)"><i class="fas fa-redo"></i></button>
                <button class="btn-control" onclick="nextTrack()"><i class="fas fa-step-forward"></i></button>
            </div>
        </div>

        <div id="playlist-modal" class="modal">
            <h3>Select Playlist</h3>
            <div class="list-container" id="playlist-list">Loading...</div>
            <button class="close-modal" onclick="closeModals()">Close</button>
        </div>

        <div id="device-modal" class="modal">
            <h3>Select Device</h3>
            <div class="list-container" id="device-list">Loading...</div>
            <button class="close-modal" onclick="closeModals()">Close</button>
        </div>
    </div>

<script>
    // --- CONFIGURATION ---
    const clientId = 'ae4f9dd4cc124d92b33737be4ff31c1f'; // PASTE YOUR CLIENT ID HERE
    
    // We strip the query parameters (?) to get the base URL for redirection
    const redirectUri = window.location.href.split('?')[0]; 
    
    const scope = "user-read-playback-state user-modify-playback-state user-read-currently-playing playlist-read-private playlist-read-collaborative";

    // --- PKCE AUTHENTICATION LOGIC ---

    function generateRandomString(length) {
        let text = '';
        const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        for (let i = 0; i < length; i++) {
            text += possible.charAt(Math.floor(Math.random() * possible.length));
        }
        return text;
    }

    async function generateCodeChallenge(codeVerifier) {
        const data = new TextEncoder().encode(codeVerifier);
        const digest = await window.crypto.subtle.digest('SHA-256', data);
        return btoa(String.fromCharCode.apply(null, [...new Uint8Array(digest)]))
            .replace(/\+/g, '-')
            .replace(/\//g, '_')
            .replace(/=+$/, '');
    }

    async function startAuthFlow() {
        const codeVerifier = generateRandomString(128);
        window.localStorage.setItem('code_verifier', codeVerifier);

        const codeChallenge = await generateCodeChallenge(codeVerifier);
        const authUrl = new URL("https://accounts.spotify.com/authorize");

        const params = {
            response_type: 'code',
            client_id: clientId,
            scope: scope,
            code_challenge_method: 'S256',
            code_challenge: codeChallenge,
            redirect_uri: redirectUri,
        };

        authUrl.search = new URLSearchParams(params).toString();
        window.location.href = authUrl.toString();
    }

    async function getToken(code) {
        const codeVerifier = window.localStorage.getItem('code_verifier');
        const payload = {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                client_id: clientId,
                grant_type: 'authorization_code',
                code: code,
                redirect_uri: redirectUri,
                code_verifier: codeVerifier,
            }),
        };

        const body = await fetch("https://accounts.spotify.com/api/token", payload);
        const response = await body.json();

        if (response.access_token) {
            window.localStorage.setItem('access_token', response.access_token);
            window.localStorage.setItem('refresh_token', response.refresh_token);
            // Clear code from URL
            window.history.replaceState({}, document.title, redirectUri);
            document.getElementById('login-overlay').style.display = 'none';
            startPolling();
        } else {
            alert("Error getting token. Check console.");
            console.error(response);
        }
    }

    // --- MAIN LOGIC ---

    async function onPageLoad() {
        const args = new URLSearchParams(window.location.search);
        const code = args.get('code');

        if (code) {
            // We just came back from Spotify
            await getToken(code);
        } else if (window.localStorage.getItem('access_token')) {
            // We already have a token
            document.getElementById('login-overlay').style.display = 'none';
            startPolling();
        } else {
            // We need to login
            document.getElementById('login-overlay').style.display = 'flex';
        }
    }

    // --- API CALLS ---

    async function fetchApi(endpoint, method = "GET", body = null) {
        let token = window.localStorage.getItem('access_token');
        if (!token) return;

        const opts = {
            method: method,
            headers: { 'Authorization': `Bearer ${token}` }
        };
        if (body) {
            opts.headers['Content-Type'] = 'application/json';
            opts.body = JSON.stringify(body);
        }

        try {
            const res = await fetch(`https://api.spotify.com/v1/${endpoint}`, opts);
            
            if (res.status === 204) return null;
            if (res.status === 401) {
                // Token expired - in a real app we would use the refresh token here
                // For now, we logout to force a new login
                window.localStorage.removeItem('access_token');
                window.location.reload(); 
            }
            return res.json();
        } catch (e) {
            console.error("API Error", e);
        }
    }

    // --- PLAYER CONTROLS ---

    let currentProgress = 0;

    async function updateState() {
        const data = await fetchApi('me/player');
        if (!data || !data.item) {
            document.getElementById('track-name').innerText = "No Active Device";
            document.getElementById('artist-name').innerText = "Open Spotify on a device";
            return;
        }

        document.getElementById('track-name').innerText = data.item.name;
        document.getElementById('artist-name').innerText = data.item.artists.map(a => a.name).join(', ');
        currentProgress = data.progress_ms;

        const playBtn = document.getElementById('play-pause-btn');
        playBtn.innerHTML = data.is_playing ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';

        const albumImg = data.item.album.images[0].url;
        document.getElementById('bg-image').style.backgroundImage = `url(${albumImg})`;
    }

    async function togglePlay() {
        const data = await fetchApi('me/player');
        if (data && data.is_playing) {
            await fetchApi('me/player/pause', 'PUT');
        } else {
            await fetchApi('me/player/play', 'PUT');
        }
        setTimeout(updateState, 500);
    }

    async function nextTrack() {
        await fetchApi('me/player/next', 'POST');
        setTimeout(updateState, 500);
    }

    async function previousTrack() {
        await fetchApi('me/player/previous', 'POST');
        setTimeout(updateState, 500);
    }

    async function seek(amountMs) {
        const newPos = Math.max(0, currentProgress + amountMs);
        await fetchApi(`me/player/seek?position_ms=${newPos}`, 'PUT');
        setTimeout(updateState, 500);
    }

    // --- PLAYLISTS & DEVICES ---

    function closeModals() {
        document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
    }

    async function openPlaylists() {
        closeModals();
        document.getElementById('playlist-modal').classList.add('active');
        const list = document.getElementById('playlist-list');
        list.innerHTML = "Loading...";
        
        const data = await fetchApi('me/playlists?limit=20');
        if (!data) return;

        list.innerHTML = '';
        data.items.forEach(playlist => {
            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerText = playlist.name;
            div.onclick = async () => {
                await fetchApi('me/player/play', 'PUT', { context_uri: playlist.uri });
                closeModals();
                setTimeout(updateState, 1000);
            };
            list.appendChild(div);
        });
    }

    async function openDevices() {
        closeModals();
        document.getElementById('device-modal').classList.add('active');
        const list = document.getElementById('device-list');
        list.innerHTML = "Loading...";

        const data = await fetchApi('me/player/devices');
        if (!data) return;

        list.innerHTML = '';
        data.devices.forEach(device => {
            const div = document.createElement('div');
            div.className = 'list-item' + (device.is_active ? ' active-device' : '');
            div.innerText = `${device.name} (${device.type})`;
            div.onclick = async () => {
                await fetchApi('me/player', 'PUT', { device_ids: [device.id] });
                closeModals();
                setTimeout(updateState, 1000);
            };
            list.appendChild(div);
        });
    }

    let pollInterval;
    function startPolling() {
        updateState();
        if (pollInterval) clearInterval(pollInterval);
        pollInterval = setInterval(updateState, 3000);
    }

    window.onload = onPageLoad;

</script>
</body>
</html>