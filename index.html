<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Circular Spotify Remote</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1DB954;
            --dark: #191414;
            --light: #FFFFFF;
        }

        body {
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            color: var(--light);
        }

        /* The Circular Screen Container */
        #device-screen {
            width: 400px;
            height: 400px;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            background-color: var(--dark);
            box-shadow: 0 0 50px rgba(255, 255, 255, 0.1);
            border: 4px solid #333;
        }

        /* Dynamic Album Art Background */
        #bg-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            filter: blur(8px) brightness(0.4);
            z-index: 0;
            transition: background-image 0.5s ease;
        }

        /* Content Overlay */
        .content-layer {
            position: relative;
            z-index: 2;
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 40px 0; /* Vertical padding to keep items inside circle */
            box-sizing: border-box;
        }

        /* Top Controls (Playlist & Devices) */
        .top-controls {
            display: flex;
            gap: 60px;
            margin-top: 20px;
        }

        .icon-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            font-size: 1.2rem;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            backdrop-filter: blur(5px);
            transition: background 0.2s;
        }

        .icon-btn:hover { background: rgba(255, 255, 255, 0.3); }
        .icon-btn:active { transform: scale(0.95); }

        /* Track Info (Center) */
        .track-info {
            text-align: center;
            width: 70%;
        }

        #track-name {
            font-size: 1.4rem;
            font-weight: bold;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #artist-name {
            font-size: 1rem;
            color: #ccc;
            margin: 5px 0 0 0;
        }

        /* Bottom Controls (Playback) */
        .bottom-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .play-btn {
            width: 70px;
            height: 70px;
            font-size: 2rem;
            background: var(--primary);
            color: white;
        }
        
        .play-btn:hover { background: #1ed760; }

        /* Login Overlay */
        #login-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark);
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            border-radius: 50%;
        }

        #login-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 20px;
        }

        /* Modals (Playlists/Devices) */
        .modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 5;
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            padding-top: 60px;
            overflow-y: auto;
        }

        .modal-title { margin-bottom: 20px; font-weight: bold; }
        
        .list-item {
            width: 70%;
            padding: 10px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            text-align: center;
            font-size: 0.9rem;
        }
        .list-item:hover { color: var(--primary); }
        .close-modal { margin-top: 20px; color: #888; cursor: pointer; padding-bottom: 40px;}

        /* Scrollbar hiding for circle */
        ::-webkit-scrollbar { width: 0px; background: transparent; }

    </style>
</head>
<body>

    <div id="device-screen">
        <div id="bg-image"></div>

        <div id="login-screen">
            <i class="fa-brands fa-spotify" style="font-size: 3rem; margin-bottom: 10px;"></i>
            <h3>Remote Control</h3>
            <p style="font-size: 0.8rem; padding: 0 40px; color: #aaa;">Connect to your Spotify account to control playback.</p>
            <button id="login-btn">CONNECT SPOTIFY</button>
        </div>

        <div class="content-layer" id="main-interface" style="display: none;">
            
            <div class="top-controls">
                <button class="icon-btn" id="playlist-btn" title="Library"><i class="fa-solid fa-list-music"></i></button>
                <button class="icon-btn" id="device-btn" title="Devices"><i class="fa-solid fa-mobile-screen"></i></button>
            </div>

            <div class="track-info">
                <h2 id="track-name">Not Playing</h2>
                <p id="artist-name">Connect a device</p>
            </div>

            <div class="bottom-controls">
                <button class="icon-btn" onclick="seek(-15000)"><i class="fa-solid fa-rotate-left"></i></button>
                <button class="icon-btn" onclick="control('previous')"><i class="fa-solid fa-backward-step"></i></button>
                <button class="icon-btn play-btn" id="play-pause-btn" onclick="togglePlay()"><i class="fa-solid fa-play"></i></button>
                <button class="icon-btn" onclick="control('next')"><i class="fa-solid fa-forward-step"></i></button>
                <button class="icon-btn" onclick="seek(15000)"><i class="fa-solid fa-rotate-right"></i></button>
            </div>
        </div>

        <div id="playlist-modal" class="modal">
            <div class="modal-title">SELECT PLAYLIST</div>
            <div id="playlist-container"></div>
            <div class="close-modal" onclick="closeModals()">Close</div>
        </div>

        <div id="device-modal" class="modal">
            <div class="modal-title">SWITCH DEVICE</div>
            <div id="device-container"></div>
            <div class="close-modal" onclick="closeModals()">Close</div>
        </div>

    </div>

    <script>
        // --- CONFIGURATION ---
        const CLIENT_ID = 'ae4f9dd4cc124d92b33737be4ff31c1f'; // <--- PASTE YOUR ID HERE AGAIN
        const REDIRECT_URI = 'http://127.0.0.1:5500/index.html'; 
        
        const SCOPES = [
            'user-read-playback-state',
            'user-modify-playback-state',
            'user-read-currently-playing',
            'playlist-read-private',
            'playlist-read-collaborative'
        ];

        // --- AUTHENTICATION ---
        const loginBtn = document.getElementById('login-btn');
        const loginScreen = document.getElementById('login-screen');
        const mainInterface = document.getElementById('main-interface');
        
        let accessToken = null;

        // 1. Check if we just came back from Spotify
        const hash = window.location.hash
            .substring(1)
            .split('&')
            .reduce(function (initial, item) {
                if (item) {
                    var parts = item.split('=');
                    initial[parts[0]] = decodeURIComponent(parts[1]);
                }
                return initial;
            }, {});

        // Clear the ugly URL hash
        window.location.hash = '';

        if (hash.access_token) {
            accessToken = hash.access_token;
            loginScreen.style.display = 'none';
            mainInterface.style.display = 'flex';
            startPolling();
        }

        loginBtn.addEventListener('click', () => {
            // FIX 1: This is the CORRECT Spotify Login Address
            let authUrl = 'https://accounts.spotify.com/authorize';
            authUrl += `?client_id=${CLIENT_ID}`;
            authUrl += `&response_type=token`;
            authUrl += `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
            authUrl += `&scope=${encodeURIComponent(SCOPES.join(' '))}`;
            authUrl += `&show_dialog=true`; // Forces the "Agree" popup so you know it worked

            window.location.href = authUrl;
        });

        // --- PLAYER CONTROLS ---

        async function fetchWebApi(endpoint, method, body) {
            // FIX 2: This is the CORRECT Spotify API Address
            // We remove the leading slash from endpoint if it exists to avoid double slashes
            const cleanEndpoint = endpoint.startsWith('/') ? endpoint.substring(1) : endpoint;
            
            const res = await fetch(`https://api.spotify.com/${cleanEndpoint}`, {
                headers: {
                    Authorization: `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                method,
                body: JSON.stringify(body)
            });
            return res;
        }

        async function updateState() {
            if(!accessToken) return;
            
            const res = await fetchWebApi('v1/me/player', 'GET');
            
            // If Spotify is not open or not playing anything, it returns 204 (Empty)
            if (res.status === 204) {
                document.getElementById('track-name').innerText = "Open Spotify";
                document.getElementById('artist-name').innerText = "Play a song on your phone to start";
                return; 
            }
            
            if (res.status > 400) {
                console.log("Error fetching state");
                return;
            }

            const data = await res.json();
            
            // Update UI
            document.getElementById('track-name').innerText = data.item.name;
            document.getElementById('artist-name').innerText = data.item.artists.map(a => a.name).join(', ');
            
            const imgUrl = data.item.album.images[0].url;
            document.getElementById('bg-image').style.backgroundImage = `url(${imgUrl})`;

            const playIcon = document.getElementById('play-pause-btn').querySelector('i');
            if(data.is_playing) {
                playIcon.classList.remove('fa-play');
                playIcon.classList.add('fa-pause');
            } else {
                playIcon.classList.remove('fa-pause');
                playIcon.classList.add('fa-play');
            }
        }

        async function togglePlay() {
            const res = await fetchWebApi('v1/me/player', 'GET');
            // If nothing is active, ignore click
            if(res.status === 204) {
                 alert("Please open Spotify on your device first!");
                 return;
            }
            
            const data = await res.json();
            if(data.is_playing) {
                await fetchWebApi('v1/me/player/pause', 'PUT');
            } else {
                await fetchWebApi('v1/me/player/play', 'PUT');
            }
            setTimeout(updateState, 500);
        }

        async function control(command) {
            await fetchWebApi(`v1/me/player/${command}`, 'POST');
            setTimeout(updateState, 500);
        }

        async function seek(msAmount) {
            const res = await fetchWebApi('v1/me/player', 'GET');
            if(res.status === 204) return;
            
            const data = await res.json();
            let newPos = data.progress_ms + msAmount;
            if (newPos < 0) newPos = 0;
            
            await fetchWebApi(`v1/me/player/seek?position_ms=${newPos}`, 'PUT');
        }

        // --- MODALS ---

        const playlistModal = document.getElementById('playlist-modal');
        const deviceModal = document.getElementById('device-modal');

        function closeModals() {
            playlistModal.style.display = 'none';
            deviceModal.style.display = 'none';
        }

        document.getElementById('playlist-btn').addEventListener('click', async () => {
            closeModals();
            playlistModal.style.display = 'flex';
            const container = document.getElementById('playlist-container');
            container.innerHTML = 'Loading...';

            const res = await fetchWebApi('v1/me/playlists?limit=10', 'GET');
            const data = await res.json();
            
            container.innerHTML = '';
            if(data.items) {
                data.items.forEach(playlist => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerText = playlist.name;
                    div.onclick = async () => {
                        await fetchWebApi('v1/me/player/play', 'PUT', { context_uri: playlist.uri });
                        closeModals();
                        setTimeout(updateState, 1000);
                    };
                    container.appendChild(div);
                });
            }
        });

        document.getElementById('device-btn').addEventListener('click', async () => {
            closeModals();
            deviceModal.style.display = 'flex';
            const container = document.getElementById('device-container');
            container.innerHTML = 'Loading...';

            const res = await fetchWebApi('v1/me/player/devices', 'GET');
            const data = await res.json();

            container.innerHTML = '';
            if(data.devices) {
                data.devices.forEach(device => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `${device.name} <span style="font-size:0.7em; color:#888;">${device.type}</span>`;
                    if(device.is_active) div.style.color = 'var(--primary)';
                    
                    div.onclick = async () => {
                        await fetchWebApi('v1/me/player', 'PUT', { device_ids: [device.id] });
                        closeModals();
                        setTimeout(updateState, 1000);
                    };
                    container.appendChild(div);
                });
            }
        });

        function startPolling() {
            updateState();
            setInterval(updateState, 3000); 
        }
    </script>
</body>
</html>